<!--账单明细页-->
<view class="page-container">
  <!-- Tab 切换 -->
  <view class="tabs-header">
    <view class="tab {{activeTab === 'records' ? 'active' : ''}}" bindtap="switchTab" data-tab="records">
      <text>账单明细</text>
    </view>
    <view class="tab {{activeTab === 'stats' ? 'active' : ''}}" bindtap="switchTab" data-tab="stats">
      <text>统计分析</text>
    </view>
    <view class="tab-indicator" style="transform: translateX({{activeTab === 'stats' ? '100%' : '0'}})"></view>
  </view>
  
  <!-- 账单明细 -->
  <view class="tab-content" wx:if="{{activeTab === 'records'}}">
    <!-- 月份选择 -->
    <view class="month-selector">
      <view class="month-nav" bindtap="prevMonth">
        <image src="/assets/icons/chevron-left.png" mode="aspectFit"></image>
      </view>
      <picker mode="date" fields="month" value="{{currentMonthStr}}" bindchange="onMonthChange">
        <view class="month-display">
          <text>{{currentYear}}年{{currentMonth}}月</text>
          <image src="/assets/icons/chevron-down.png" mode="aspectFit"></image>
        </view>
      </picker>
      <view class="month-nav" bindtap="nextMonth">
        <image src="/assets/icons/chevron-right.png" mode="aspectFit"></image>
      </view>
    </view>
    
    <!-- 月度汇总 -->
    <view class="month-summary">
      <view class="summary-item">
        <text class="label">收入</text>
        <text class="value income">+{{monthIncomeDisplay}}</text>
      </view>
      <view class="summary-item">
        <text class="label">支出</text>
        <text class="value expense">-{{monthExpenseDisplay}}</text>
      </view>
      <view class="summary-item">
        <text class="label">结余</text>
        <text class="value {{monthBalance >= 0 ? 'positive' : 'negative'}}">{{monthBalanceDisplay}}</text>
      </view>
    </view>
    
    <!-- 记录列表 -->
    <view class="records-container" wx:if="{{groupedRecords.length > 0}}">
      <view class="date-group" wx:for="{{groupedRecords}}" wx:key="date">
        <view class="date-header">
          <text class="date-label">{{item.dateLabel}}</text>
          <view class="date-summary">
            <text class="income" wx:if="{{item.totalIncome > 0}}">+{{item.incomeDisplay}}</text>
            <text class="expense" wx:if="{{item.totalExpense > 0}}">-{{item.expenseDisplay}}</text>
          </view>
        </view>
        
        <view class="record-list">
          <view 
            class="record-item" 
            wx:for="{{item.records}}" 
            wx:for-item="record" 
            wx:key="id"
            bindtap="editRecord"
            data-id="{{record.id}}"
          >
            <view class="record-icon {{record.type}}">
              <image src="/assets/icons/category/{{record.categoryIcon}}.png" mode="aspectFit"></image>
            </view>
            <view class="record-info">
              <text class="record-category">{{record.categoryName}}</text>
              <text class="record-note" wx:if="{{record.note}}">{{record.note}}</text>
            </view>
            <text class="record-amount {{record.type}}">{{record.type === 'income' ? '+' : '-'}}{{record.amountDisplay}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:else>
      <image src="/assets/icons/empty.png" mode="aspectFit"></image>
      <text>本月暂无记录</text>
    </view>
  </view>
  
  <!-- 统计分析 -->
  <view class="tab-content" wx:if="{{activeTab === 'stats'}}">
    <!-- 时间范围选择器 -->
    <view class="time-range-selector">
      <view 
        class="range-option {{selectedTimeRange === item.key ? 'active' : ''}}" 
        wx:for="{{timeRangeOptions}}" 
        wx:key="key"
        bindtap="onTimeRangeChange"
        data-range="{{item.key}}"
      >
        <text>{{item.label}}</text>
      </view>
    </view>

    <!-- 总览卡片 -->
    <view class="stats-overview">
      <view class="overview-card income-card">
        <text class="card-label">总收入</text>
        <text class="card-value">¥{{totalIncomeDisplay}}</text>
      </view>
      <view class="overview-card expense-card">
        <text class="card-label">总支出</text>
        <text class="card-value">¥{{totalExpenseDisplay}}</text>
      </view>
    </view>
    
    <!-- 月度趋势 -->
    <view class="stats-section">
      <view class="section-header">
        <text class="section-title">收支趋势</text>
        <text class="section-hint">{{needScroll ? '左右滑动查看更多 · ' : ''}}点击柱状图查看详情</text>
      </view>
      <view class="trend-chart">
        <scroll-view 
          class="chart-scroll {{needScroll ? 'scrollable' : ''}}" 
          scroll-x="{{needScroll}}" 
          enhanced="{{true}}"
          show-scrollbar="{{false}}"
          scroll-into-view="{{scrollToView}}"
          scroll-with-animation="{{true}}"
        >
          <view class="chart-bars {{needScroll ? 'chart-bars-scroll' : ''}}">
            <view 
              class="bar-group {{item.isSelected ? 'selected' : ''}}" 
              id="bar-{{index}}"
              wx:for="{{monthlyTrend}}" 
              wx:key="month"
              bindtap="onBarTap"
              data-index="{{index}}"
            >
              <view class="bar-wrapper">
                <view class="bar income-bar" style="height: {{item.incomeHeight}}rpx;">
                  <view class="bar-tooltip" wx:if="{{item.isSelected}}">{{item.incomeDisplay}}</view>
                </view>
                <view class="bar expense-bar" style="height: {{item.expenseHeight}}rpx;">
                  <view class="bar-tooltip expense" wx:if="{{item.isSelected}}">{{item.expenseDisplay}}</view>
                </view>
              </view>
              <text class="bar-label">{{item.month}}</text>
            </view>
          </view>
        </scroll-view>
        <view class="chart-legend">
          <view class="legend-item">
            <view class="legend-dot income"></view>
            <text>收入</text>
          </view>
          <view class="legend-item">
            <view class="legend-dot expense"></view>
            <text>支出</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 柱状图详情弹窗 - 增强版带饼状图 -->
    <view class="bar-detail-popup {{showBarDetail ? 'show' : ''}}" bindtap="closeBarDetail">
      <view class="popup-content enhanced" catchtap="">
        <view class="popup-header">
          <text class="popup-title">{{barDetailData.month}} 收支详情</text>
          <view class="popup-close" bindtap="closeBarDetail">×</view>
        </view>
        <view class="popup-body">
          <!-- 收支概览卡片 -->
          <view class="overview-row">
            <view class="overview-item income-item">
              <text class="overview-label">收入</text>
              <text class="overview-value income">+¥{{barDetailData.income}}</text>
            </view>
            <view class="overview-item expense-item">
              <text class="overview-label">支出</text>
              <text class="overview-value expense">-¥{{barDetailData.expense}}</text>
            </view>
          </view>
          
          <!-- 结余 -->
          <view class="balance-row">
            <text class="balance-label">结余</text>
            <text class="balance-value {{barDetailData.balancePositive ? 'positive' : 'negative'}}">¥{{barDetailData.balance}}</text>
          </view>
          
          <!-- 收支对比环形图 -->
          <view class="chart-section" wx:if="{{barDetailData.hasData}}">
            <text class="chart-title">收支对比</text>
            <view class="ring-chart-container">
              <view class="ring-chart">
                <view class="ring-segment income-segment" style="--percentage: {{barDetailData.incomePercent}};"></view>
                <view class="ring-segment expense-segment" style="--percentage: {{barDetailData.expensePercent}}; --rotation: {{barDetailData.incomePercent * 3.6}}deg;"></view>
                <view class="ring-center">
                  <text class="ring-total-label">总额</text>
                  <text class="ring-total-value">¥{{barDetailData.total}}</text>
                </view>
              </view>
              <view class="ring-legend">
                <view class="legend-row">
                  <view class="legend-color income"></view>
                  <text class="legend-text">收入 {{barDetailData.incomePercent}}%</text>
                </view>
                <view class="legend-row">
                  <view class="legend-color expense"></view>
                  <text class="legend-text">支出 {{barDetailData.expensePercent}}%</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 分类饼状图 - 支出 -->
          <view class="chart-section" wx:if="{{barDetailData.expenseCategories.length > 0}}">
            <text class="chart-title">支出分类占比</text>
            <view class="pie-chart-container">
              <view class="pie-chart">
                <view 
                  class="pie-segment" 
                  wx:for="{{barDetailData.expenseCategories}}" 
                  wx:key="category"
                  style="--color: {{item.color}}; --percentage: {{item.percentage}}; --rotation: {{item.rotation}}deg;"
                ></view>
              </view>
              <view class="pie-legend">
                <view 
                  class="pie-legend-item" 
                  wx:for="{{barDetailData.expenseCategories}}" 
                  wx:key="category"
                  wx:if="{{index < 5}}"
                >
                  <view class="pie-legend-color" style="background-color: {{item.color}};"></view>
                  <text class="pie-legend-name">{{item.name}}</text>
                  <text class="pie-legend-percent">{{item.percentDisplay}}%</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 分类饼状图 - 收入 -->
          <view class="chart-section" wx:if="{{barDetailData.incomeCategories.length > 0}}">
            <text class="chart-title">收入分类占比</text>
            <view class="pie-chart-container">
              <view class="pie-chart">
                <view 
                  class="pie-segment" 
                  wx:for="{{barDetailData.incomeCategories}}" 
                  wx:key="category"
                  style="--color: {{item.color}}; --percentage: {{item.percentage}}; --rotation: {{item.rotation}}deg;"
                ></view>
              </view>
              <view class="pie-legend">
                <view 
                  class="pie-legend-item" 
                  wx:for="{{barDetailData.incomeCategories}}" 
                  wx:key="category"
                  wx:if="{{index < 5}}"
                >
                  <view class="pie-legend-color" style="background-color: {{item.color}};"></view>
                  <text class="pie-legend-name">{{item.name}}</text>
                  <text class="pie-legend-percent">{{item.percentDisplay}}%</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 无数据提示 -->
          <view class="no-data-hint" wx:if="{{!barDetailData.hasData}}">
            <text>该月暂无记录数据</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 分类占比 - 带收入/支出切换 -->
    <view class="stats-section">
      <view class="section-header">
        <text class="section-title">分类占比</text>
        <view class="stats-type-toggle">
          <view 
            class="toggle-option {{statsType === 'expense' ? 'active' : ''}}" 
            bindtap="onStatsTypeChange" 
            data-type="expense"
          >
            <text>支出</text>
          </view>
          <view 
            class="toggle-option {{statsType === 'income' ? 'active' : ''}}" 
            bindtap="onStatsTypeChange" 
            data-type="income"
          >
            <text>收入</text>
          </view>
        </view>
      </view>
      
      <view class="category-list" wx:if="{{categoryBreakdown.length > 0}}">
        <view 
          class="category-item" 
          wx:for="{{categoryBreakdown}}" 
          wx:key="category"
          bindtap="onCategoryTap"
          data-category="{{item.category}}"
          data-name="{{item.name}}"
        >
          <view class="category-left">
            <view class="category-icon" style="background-color: {{item.color}}20;">
              <image src="/assets/icons/category/{{item.icon}}.png" mode="aspectFit"></image>
            </view>
            <text class="category-name">{{item.name}}</text>
          </view>
          <view class="category-right">
            <text class="category-amount">¥{{item.amountDisplay}}</text>
            <text class="category-percent">{{item.percentDisplay}}%</text>
          </view>
          <view class="category-bar" style="width: {{item.percentage}}%; background-color: {{item.color}};"></view>
          <view class="category-arrow">
            <image src="/assets/icons/chevron-right.png" mode="aspectFit"></image>
          </view>
        </view>
      </view>
      
      <view class="empty-category" wx:else>
        <text>暂无{{statsType === 'expense' ? '支出' : '收入'}}数据</text>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{categoryBreakdown.length === 0 && monthlyTrend.length === 0}}">
      <image src="/assets/icons/empty.png" mode="aspectFit"></image>
      <text>暂无统计数据</text>
    </view>
  </view>
</view>

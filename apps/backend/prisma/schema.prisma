// Prisma Schema for Personal Accounting App
// 注意：此 schema 需与 packages/shared/src/types/index.ts 保持同步

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表 - 对应 shared/types User 接口
model User {
  id        String   @id @default(cuid())
  openid    String   @unique // 微信 openid
  unionid   String?  @unique // 微信 unionid（可选）
  nickname  String?
  avatar    String?
  password  String?  // 密码（可选，Web 端使用）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联
  records Record[]
  ledgers Ledger[]

  @@map("users")
}

// 账本表 - 对应 shared/types Ledger 接口
model Ledger {
  id        String    @id @default(cuid())
  name      String
  icon      String?
  color     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") // 软删除

  // 客户端 ID（用于备份/恢复时匹配）
  clientId String? @map("client_id")

  // 关联
  userId  String   @map("user_id")
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  records Record[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@map("ledgers")
}

// 记账记录表 - 对应 shared/types Record 接口
model Record {
  id        String     @id @default(cuid())
  type      RecordType
  amount    Decimal
  category  String
  date      DateTime
  note      String?
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  deletedAt DateTime?  @map("deleted_at") // 软删除

  // 客户端 ID（用于备份/恢复时匹配本地记录）
  clientId String? @map("client_id")

  // 关联
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  ledgerId String @map("ledger_id") // 所属账本（必填）
  ledger   Ledger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, deletedAt])
  @@index([userId, clientId]) // 用于备份时按 clientId 查找
  @@index([ledgerId])
  @@map("records")
}

// 记录类型枚举
enum RecordType {
  income
  expense
}
